var plain,solutions=[],cipher,key,numSols,uInt8Array,isRunning,numHoles,gridWd,mask=[],used=[];function decipherGrille(){"function"===typeof importScripts&&(importScripts("../support/decipherLib.js"),importScripts("../support/cryptoPrograms.js"));initSolution();numHoles=Math.floor(cipher.length/4);"undefined"!==typeof key&&(0<key.length?solveWithKeyword():solveGrille());!1===isRunning&&self.postMessage({cmd:"STOP",msg:""})}
function solveGrille(){var b,a,c,g,f,d=[],l=[];var k=0;var h=cipher.length;gridWd=Math.sqrt(h);if(1===gridWd%2){var m=Math.floor(h/2);var p=cipher[m].toLowerCase();var q=!0}else p="",q=!1;isRunning=!0;for(b=0;b<h;b+=1)used[b]=0;for(g=0;5E4>g;g+=1)if(isRunning){if(0===g%200)for(randomiseGrille(d),a=0;a<h;a+=1)l[a]=d[a];for(c=f=0;500>c;c+=1){for(a=0;a<h;a+=1)d[a]=l[a];do{a=Math.floor(Math.random()*h);var e=Math.floor(Math.random()*h)}while(a===e||!0===q&&(a===m||e===m));setHolesInMask(d,gridWd,a,!1);
setHolesInMask(d,gridWd,e,!1);plain=decrypt(d)+p;e=getTetraScore(plain.replace(/[^a-z]/g,""));if(e>f)for(f=e,a=0;a<d.length;a+=1)l[a]=d[a];if(e>k){k=e;for(a=0;a<h;a+=1);var n="";for(a=0;a<h;a+=1)0===d[a]&&(n+=a+1+" ");solutions[numSols-1]<k&&(solutions[numSols-1]=k,solutions.sort(function(r,t){return t-r}),self.postMessage({cmd:"reslt",key:n,score:e,text:plain}))}for(a=0;a<d.length;a+=1)d[a]=l[a];for(b=0;500>b;b+=1){do a=Math.floor(Math.random()*h),e=Math.floor(Math.random()*h);while(a===e||!0===
q&&(a===m||e===m));setHolesInMask(d,gridWd,a,!1);setHolesInMask(d,gridWd,e,!1);plain=decrypt(d)+p;e=getTetraScore(plain.replace(/[^a-z]/g,""));if(e>f)for(f=e,a=0;a<d.length;a+=1)l[a]=d[a];if(e>k){k=e;for(a=0;a<h;a+=1);n="";for(a=0;a<h;a+=1)0===d[a]&&(n+=a+1+" ");solutions[numSols-1]<k&&(solutions[numSols-1]=k,solutions.sort(function(r,t){return t-r}),self.postMessage({cmd:"reslt",key:n,score:e,text:plain}))}}}}isRunning=!1}
function randomiseGrille(b){var a,c;var g=cipher.length;for(a=0;a<g;a+=1)used[a]=0;1===gridWd%2&&(used[Math.floor(g/2)]=1,b[Math.floor(g/2)]=4);for(a=0;a<numHoles;a+=1){for(c=Math.floor(Math.random()*g);used[c];)c=Math.floor(Math.random()*g);setHolesInMask(b,gridWd,c,!0);used[c]=1}}function setHolesInMask(b,a,c,g){var f=Math.floor(c/a),d=c%a;b[c]=0;for(c=1;3>=c;c+=1){var l=f;f=d;d=a-1-l;b[f*a+d]=c;g&&(used[f*a+d]=1)}}
function decrypt(b){var a,c=[],g=[];for(a=0;5>a;a+=1)c[a]=0;for(a=0;a<cipher.length;a+=1){var f=b[a];4!==f&&(g[f*numHoles+c[f]]=cipher[a],c[f]+=1)}return g.join("").toLowerCase()}
function solveWithKeyword(){var b,a=[];var c=cipher.length;gridWd=Math.sqrt(c);a=key.split(/[ ,]+/);for(b=0;b<c;b+=1)used[b]=0;1===gridWd%2&&(used[Math.floor(c/2)]=1,mask[Math.floor(c/2)]=4);for(b=0;b<numHoles;b+=1)if(0===used[b])setHolesInMask(mask,gridWd,a[b]-1,!1);else{alert("Cell position clash in cell "+a[b]);return}b=1===gridWd%2?cipher[Math.floor(c/2)].toLowerCase():"";plain=decrypt(mask)+b;0<plain.length&&(b=getTetraScore(plain.replace(/[^a-z]/g,"")),solutions[numSols-1]<b&&(solutions[numSols-
1]=b,solutions.sort(function(g,f){return f-g}),self.postMessage({cmd:"reslt",key:key,score:b,text:plain})));isRunning=!1}self.addEventListener("message",function(b){b=b.data;cipher=b.cipher;uInt8Array=b.uInt8Array;numSols=b.numSols;key=b.key;decipherGrille()},!1);