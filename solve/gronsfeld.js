var plain,period,key=[],solutions=[],cipher,keyword,minPeriod,maxPeriod,numSols,uInt8Array,workerNumber,totalWorkers,isRunning;function decipherGronsfeld(){"function"===typeof importScripts&&(importScripts("../support/decipherLib.js"),importScripts("../support/cryptoPrograms.js"));key.length=0;initSolution();"undefined"!==typeof keyword&&(0<keyword.length?solveWithKeyword():solveGronsfeld());!1===isRunning&&self.postMessage({cmd:"STOP",msg:""})}
function solveGronsfeld(){var a,b,c,d,e;var g=ord("A");var h=[];var p=englishAlph.substr(0,10);var t=p.length;var r=0;var l=minPeriod===maxPeriod?minPeriod:minPeriod+workerNumber;isRunning=!0;for(period=l;period<=maxPeriod;period+=totalWorkers)for(a=e=0;10>a;a+=1)for(h[0]=a,b=0;10>b;b+=1)for(h[1]=b,c=0;10>c;c+=1)for(h[2]=c,d=0;10>d;d+=1){h[3]=d;var f=getTestKeyScore(h,4,0);if(0<f){e=f;key[0]=chr(a+g);key[1]=chr(b+g);key[2]=chr(c+g);key[3]=chr(d+g);getRemainingKey(10);plain=decipher(key);var k=getTetraScore(plain);
if(solutions[numSols-1]<k){solutions[numSols-1]=k;solutions.sort(function(m,n){return n-m});var q=key.join("").substr(0,period);self.postMessage({cmd:"reslt",key:q,score:k,text:plain.toLowerCase()})}}}period=l;a:for(;period<=maxPeriod;period+=totalWorkers)for(a=0;1E3>a;a+=1)if(isRunning)for(d=keyword=period===q.length?q:randomKey(p,period),plain=decipher(keyword),k=getTetraScore(plain),solutions[numSols-1]<k&&(solutions[numSols-1]=k,solutions.sort(function(m,n){return n-m}),self.postMessage({cmd:"reslt",
key:keyword,score:k,text:plain})),c=15;1<c;--c)if(isRunning){e=b=0;do f=Math.floor(Math.random()*t),l=p.substr(f,1),f=Math.floor(Math.random()*period),keyword=keyword.substr(0,f)+l+keyword.substr(f+1),plain=decipher(keyword),f=getTetraScore(plain),f>e&&(e=f,e>r&&(r=e)),solutions[numSols-1]<f&&(solutions[numSols-1]=f,solutions.sort(function(m,n){return n-m}),self.postMessage({cmd:"reslt",key:keyword,score:f,text:plain})),g=f-k,l=0,0<g?l=1:(g=Math.pow(Math.E,g/c),h=(1E3*Math.random()+1)/1E3,g>h&&(l=
1)),1===l&&(keyword=d,k=f),b+=1;while(1E3>b&&isRunning)}else break a;else break a;isRunning=!1}function randomKey(a,b){var c;var d=a.substr(Math.floor(Math.random()*a.length),1);for(c=1;c<b;c+=1)d+=a.substr(Math.floor(Math.random()*a.length),1);return d}function getTestKeyScore(a,b,c){for(var d,e=0;c<cipher.length-b+1;c+=period){plain="";for(d=0;d<b;d+=1)plain+=decryptVigenere(cipher[c+d],a[d]);e+=getSingleTetraScore(plain)}return e}
function getRemainingKey(a){var b,c,d=[],e=ord("A");for(b=4;b<period;b+=1){var g=0;d[0]=ord(key[b-3])-e;d[1]=ord(key[b-2])-e;d[2]=ord(key[b-1])-e;key[b]="A";for(c=0;c<a;c+=1){d[3]=c;var h=getTestKeyScore(d,4,b-3);h>g&&(g=h,key[b]=chr(c+e))}}}function decipher(a){var b;plain="";for(b=0;b<cipher.length;b+=1)plain+=decryptVigenere(cipher[b],ord(a[b%period])-65);return plain}
function solveWithKeyword(){isRunning=!0;period=keyword.length;plain=decipher(keyword);var a=getTetraScore(plain);self.postMessage({cmd:"reslt",key:key.join(""),score:a,text:plain.toLowerCase()});isRunning=!1}self.addEventListener("message",function(a){a=a.data;cipher=a.cipher;uInt8Array=a.uInt8Array;totalWorkers=a.totalWorkers;workerNumber=a.workerNumber;numSols=a.numSols;keyword=a.keyword;minPeriod=a.minPeriod;maxPeriod=a.maxPeriod;decipherGronsfeld()},!1);